<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../../bower_components/vientos-iconset/vientos-iconset.html">
<link rel="import" href="../../widgets/vientos-icon-button/vientos-icon-button.html">

<link rel="import" href="../../cards/review-card/review-card.html">
<link rel="import" href="../../cards/intent-preview/intent-preview.html">

<link rel="import" href="vientos-conversation-styles.html">

<dom-module id="vientos-conversation">
  <template>
    <style include="vientos-conversation-styles"></style>
    <header>
      <div><paper-icon-button icon="vientos:arrow-back" on-tap="_back"></paper-icon-button></div>
    </header>
    <section id="review">
      <template is="dom-if" if="[[conversationReviews.length]]">
        <template is="dom-if" if="[[conversationReviews.0.success]]">
          <h3><iron-icon icon="vientos:success"></iron-icon>[[localize('label:successful-collaboration')]]</h3>
        </template>
        <template is="dom-if" if="[[!conversationReviews.0.success]]">
          <h3><iron-icon icon="vientos:aborted"></iron-icon>[[localize('label:aborted-conversation')]]</h3>
        </template>
        <h4>[[localize('label:reviews')]]</h4>
        <template is="dom-repeat" items="[[conversationReviews]]" as="review">
          <review-card review="[[review]]" skip-link></review-card>
        </template>
      </template>
      <template is="dom-if" if="[[_showNewReview(conversation, canReview, reviewing)]]">
        <template is="dom-if" if="[[!conversationReviews.length]]">
          <template is="dom-if" if="[[success]]">
            <h3><iron-icon icon="vientos:success"></iron-icon>[[localize('label:successful-collaboration')]]</h3>
          </template>
          <template is="dom-if" if="[[!success]]">
            <h3><iron-icon icon="vientos:aborted"></iron-icon>[[localize('label:aborted-conversation')]]</h3>
          </template>
        </template>
        <div>
          <template is="dom-if" if="[[!rating]]">
            <div class="hint">[[localize('hint:rating-required')]]</div>
          </template>
          <iron-selector selected="{{rating}}" attr-for-selected="name">
            <paper-icon-button icon="vientos:dissatisfied" name="dissatisfied"></paper-icon-button>
            <paper-icon-button icon="vientos:neutral" name="neutral"></paper-icon-button>
            <paper-icon-button icon="vientos:satisfied" name="satisfied"></paper-icon-button>
          </iron-selector>
        </div>
        <paper-textarea
          value="{{newReview}}" label="[[localize('label:review-body')]]">
        </paper-textarea>
        <paper-button raised on-tap="_sendReview" disabled="[[!rating]]">[[localize('button:review')]]</paper-button>
        <template is="dom-if" if="[[!conversationReviews.length]]">
          <paper-button raised on-tap="_abortReview">[[localize('button:cancel')]]</paper-button>
        </template>
      </template>
      <template is="dom-if" if="[[_showReviewButton(person, conversation, intents, reviewing)]]">
        <section class="action-buttons">
          <vientos-icon-button
            id="button-abort"
            raised
            on-tap="_abort"
            text="[[localize('button:abort')]]"
            icon="vientos:aborted"
            ></vientos-icon-button>
          <vientos-icon-button
            id="button-success"
            raised
            on-tap="_succeed"
            text="[[localize('button:succeed')]]"
            icon="vientos:success"
          ></vientos-icon-button>
        </section>
      </template>
    </section>
    <section>
      <intent-preview intent="[[causingIntent]]" show-projects></intent-preview>
      <template is="dom-if" if="[[matchingIntent]]">
        <intent-preview intent="[[matchingIntent]]" show-projects></intent-preview>
      </template>
    </section>
    <section>
      <ul>
        <li>
          <p>[[localize('label:questions')]]</p>
          <p>[[causingIntent.question]]</p>
        </li>
        <template is="dom-repeat" items="[[conversation.messages]]" as="message">
          <li class$="[[_classForSameTeam(person, message.creator, conversation, intents)]]">
            <div class="name">
              <iron-image src="[[_getImage(message.creator, people, 26)]]" sizing="contain"></iron-image>
              [[_getName(message.creator, people)]]
            </div>
            <div class="message" inner-h-t-m-l="[[_addHyperLinks(message.body)]]"></div>
          </li>
        </template>
      </ul>
      <template is="dom-if" if="[[showNewMessage]]">
        <div id="turn-toggle">
          <span>[[localize('label:their-turn')]]</span>
          <paper-toggle-button toggles checked="[[turnToggleChecked]]" on-tap="_toggleTurn"></paper-toggle-button>
          <span>[[localize('label:our-turn')]]</span>
        </div>
        <template is="dom-if" if="[[_toggleRequiresMessageHint(changeTurn, newMessage)]]">
          <div class="hint">[[localize('hint:change-turn-needs-message')]]</div>
        </template>
        <div id="message-controls">
          <paper-textarea value="{{newMessage}}" placeholder="[[localize('type-message')]]"></paper-textarea>
          <paper-button raised on-tap="_sendMessage" disabled="[[!newMessage]]">[[localize('button:send')]]</paper-button>
        </div>
      </template>
    </section>
  </template>

  <script src="vientos-conversation.js"></script>

</dom-module>
